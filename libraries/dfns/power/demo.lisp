;;; -*- Mode:Lisp; Syntax:ANSI-Common-Lisp; Coding:utf-8; Package:AprilLib.Dfns.Power -*-
;;;; demo.lisp

(in-package :april-lib.dfns.power)

(april-load (with (:space power-lib-space))
            (asdf:system-relative-pathname (intern (package-name *package*) "KEYWORD") "power.apl"))

(specify-demo
 "April power operators demo"
 (with :space power-lib-space
       :description "Implements power operators from Dyalog's dfns.")
 (:tests (provision "embrace ← {'(',⍵,')'} for {'[',⍵,']'} for {'{',⍵,'}'} for {'<',⍵,'>'}")
         (is "1 0 2 3 embrace 'this'" "({{<<<this>>>}})")
         (is "⌊○invr ○ 2 3⍴⍳6" #2A((1 2 3) (4 5 6)))
         (is "⌊{⍵+⍵}invr 2 4 6" #(1 2 3))
         ;; TODO: find why LW causes infinite loops with these tests
         #+(not lispworks) (is "⌊{2*⍵}invr 16" 4)
         #+(not lispworks) (is "⌊{⍵*2}invr 49" 7)
         (is "⌊{32+⍵×1.8} invr 212" 100)
         (is "⌊10000×(1∘○) invr (1∘○) 10" 685398)
         #+(not lispworks) (is "⌊1000×**invr 1.23" 1230)
         #+(not lispworks) (is "⌊1000×⍟⍟invr 1.23" 1230)
         (is "⌊1000×!!invr 1.23" 1230) ;; this has an issue with ⎕CT
         (is "⌊1000×÷÷invr 1.23" 1230)
         (is "⌊1000×○○invr 1.23" 1230)
         (provision "enlist ← {1↓↑,/'·',,,¨⍵}limit")
         (is "enlist ,∘⊂/⍳5" #(1 2 3 4 5))
         (is "⌊1000×0.5∘× limit 2" 0)
         (is "AM 1 2 3 4 5" #(3))
         (is "⌊1000×GM 1 2 3 4 5" #(2605))
         (is "⌊1000×AGM 1 2 3 4 5" 2799)
         (is "⌊1000×÷AGM 1 2*÷2" 834)
         ;; (is "⌊1000×ArcTan 0.5" 463)
         (is "⌊1000×¯3○0.5" 463)
         (is "⌊1000×⍬⍴{⍵×2-¯1↑⍵} limit 20 0.3" 66666)
         (is "6 {'<',⍵,'>'} pow 'wow'" "<<<<<<wow>>>>>>")
         (is "4 ⊂ pow 'wow'" #0A#0A#0A#0A"wow")
         (is "(1↓rl pow∘1¨⍳35)roll¨⍳34"
             #(1 2 2 3 2 1 5 6 9 4 6 10 1 1 8 11 1 7 2 9 15 13 22 21 14 3 18 12 21 28 24 9 2 26))
         (is "{2|⍵:1+3×⍵ ⋄ ⍵÷2}traj 7" #(7 22 11 34 17 52 26 13 40 20 10 5 16 8 4 2 1))
         (is "⌊1000000000×1e¯12∘(2∘○ nr)traj 1.5"
             #(1500000000 1570909012 1570796336 1570796326 1570796326 1570796326))
         (is "⌊1000000000×1e¯3 ∘(2∘○ nr)traj 1.5" #(1500000000 1570912341 1570796326 1570796326))
         (is "↓' *'[⎕io+↑≠\\traj 32⍴1]" #("********************************"
                                          "* * * * * * * * * * * * * * * * "
                                          "**  **  **  **  **  **  **  **  "
                                          "*   *   *   *   *   *   *   *   "
                                          "****    ****    ****    ****    "
                                          "* *     * *     * *     * *     "
                                          "**      **      **      **      "
                                          "*       *       *       *       "
                                          "********        ********        "
                                          "* * * *         * * * *         "
                                          "**  **          **  **          "
                                          "*   *           *   *           "
                                          "****            ****            "
                                          "* *             * *             "
                                          "**              **              "
                                          "*               *               "
                                          "****************                "
                                          "* * * * * * * *                 "
                                          "**  **  **  **                  "
                                          "*   *   *   *                   "
                                          "****    ****                    "
                                          "* *     * *                     "
                                          "**      **                      "
                                          "*       *                       "
                                          "********                        "
                                          "* * * *                         "
                                          "**  **                          "
                                          "*   *                           "
                                          "****                            "
                                          "* *                             "
                                          "**                              "
                                          "*                               "))
         (is "{2|⍵:1+3×⍵ ⋄ ⍵÷2}traj2 7" #(7 22 11 34 17 52 26 13 40 20 10 5 16 8 4 2 1))
         (is ",∘'.' while (80>⍴) 'Note'"
             "Note............................................................................")
         (is "↓⍕1 disp ↓ while {1<⍴⍴⍵} 2 2 2 2⍴⍳16"
             #("┌→────────────────────┬────────────────────────────┐"
               "│┌→────────┬─────────┐│┌→───────────┬─────────────┐│"
               "││┌→──┬───┐│┌→──┬───┐│││┌→───┬─────┐│┌→────┬─────┐││"
               "│││1 2│3 4│││5 6│7 8│││││9 10│11 12│││13 14│15 16│││"
               "││└~─→┴~─→┘│└~─→┴~─→┘│││└~──→┴~───→┘│└~───→┴~───→┘││"
               "│└────────→┴────────→┘│└───────────→┴────────────→┘│"
               "└────────────────────→┴───────────────────────────→┘"))
         (is "{⍵+1} while {0} 0" 0)
         (is "{⍵,'.'} until {60=⍴⍵} 'Note'"
             "Note........................................................")
         (is "↓⍕1 disp ↓ until {1=⍴⍴⍵} 2 2 2 2⍴⍳16"
             #("┌→────────────────────┬────────────────────────────┐"
               "│┌→────────┬─────────┐│┌→───────────┬─────────────┐│"
               "││┌→──┬───┐│┌→──┬───┐│││┌→───┬─────┐│┌→────┬─────┐││"
               "│││1 2│3 4│││5 6│7 8│││││9 10│11 12│││13 14│15 16│││"
               "││└~─→┴~─→┘│└~─→┴~─→┘│││└~──→┴~───→┘│└~───→┴~───→┘││"
               "│└────────→┴────────→┘│└───────────→┴────────────→┘│"
               "└────────────────────→┴───────────────────────────→┘"))
         (is "{⍵+1} until {1} 0" 1)
         (is "{1↓⍵} while {' '∊⍵}  'hello world'" "world")
         (is "{1↓⍵} until {~' '∊⍵} 'hello world'" "world")
         (is "{1↓⍵} while {'⎕'∊⍵}  'hello world'" "hello world")
         (is "{1↓⍵} until {~'⎕'∊⍵} 'hello world'" "ello world")))
